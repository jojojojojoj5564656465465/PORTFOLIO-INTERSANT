---

import PostsPage from '../components/pages/posts-page'
import { RECORDS_PER_PAGE } from '../constants'
import ArticleLayout from '../layouts/ArticleLayout.astro'
import { getAuthorMap } from '../lib/api/author'
import { getAllPosts } from '../lib/api/post'
import markdownHtml from '../lib/markdown-html'


const authorMap = getAuthorMap()

// Get all the posts and add the authors in
let posts = getAllPosts()

//await generateSiteMap(posts)
//await generateRSS(posts)

posts = await Promise.all(
  posts.map(async post => {
    const excerpt = await markdownHtml(post.fields.excerpt || '')
    return {
      ...post,
      excerpt,
      authors: [authorMap[post.fields.author]],
    }
  })
)

const pages = Math.floor(
  (posts.length + RECORDS_PER_PAGE - 1) / RECORDS_PER_PAGE)

---

<ArticleLayout title="Blog">
  <PostsPage posts={posts.slice(0, RECORDS_PER_PAGE)} page={1} pages={pages} />
</ArticleLayout>